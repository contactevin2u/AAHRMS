/**
 * Malaysian Statutory Deductions Calculator
 * Calculates EPF, SOCSO, EIS based on official KWSP/PERKESO tables
 *
 * EPF uses KWSP Third Schedule (contribution table)
 * SOCSO/EIS uses PERKESO contribution tables
 */

// EPF Third Schedule Part A (effective Oct 2025) - 11% employee, 13% employer for <=5000, 12% employer for >5000
// Format: [maxWage, employeeContrib, employerContrib]
// Official KWSP Third Schedule - RM20 increments up to RM5,000, RM100 increments up to RM20,000
const EPF_TABLE = [
  [10, 0, 0], [20, 3, 3], [40, 5, 6], [60, 7, 8], [80, 9, 11], [100, 11, 13],
  [120, 14, 16], [140, 16, 19], [160, 18, 21], [180, 20, 24], [200, 22, 26],
  [220, 25, 29], [240, 27, 32], [260, 29, 34], [280, 31, 37], [300, 33, 39],
  [320, 36, 42], [340, 38, 45], [360, 40, 47], [380, 42, 50], [400, 44, 52],
  [420, 47, 55], [440, 49, 58], [460, 51, 60], [480, 53, 63], [500, 55, 65],
  [520, 58, 68], [540, 60, 71], [560, 62, 73], [580, 64, 76], [600, 66, 78],
  [620, 69, 81], [640, 71, 84], [660, 73, 86], [680, 75, 89], [700, 77, 91],
  [720, 80, 94], [740, 82, 97], [760, 84, 99], [780, 86, 102], [800, 88, 104],
  [820, 91, 107], [840, 93, 110], [860, 95, 112], [880, 97, 115], [900, 99, 117],
  [920, 102, 120], [940, 104, 123], [960, 106, 125], [980, 108, 128], [1000, 110, 130],
  [1020, 113, 133], [1040, 115, 136], [1060, 117, 138], [1080, 119, 141], [1100, 121, 143],
  [1120, 124, 146], [1140, 126, 149], [1160, 128, 151], [1180, 130, 154], [1200, 132, 156],
  [1220, 135, 159], [1240, 137, 162], [1260, 139, 164], [1280, 141, 167], [1300, 143, 169],
  [1320, 146, 172], [1340, 148, 175], [1360, 150, 177], [1380, 152, 180], [1400, 154, 182],
  [1420, 157, 185], [1440, 159, 188], [1460, 161, 190], [1480, 163, 193], [1500, 165, 195],
  [1520, 168, 198], [1540, 170, 201], [1560, 172, 203], [1580, 174, 206], [1600, 176, 208],
  [1620, 179, 211], [1640, 181, 214], [1660, 183, 216], [1680, 185, 219], [1700, 187, 221],
  [1720, 190, 224], [1740, 192, 227], [1760, 194, 229], [1780, 196, 232], [1800, 198, 234],
  [1820, 201, 237], [1840, 203, 240], [1860, 205, 242], [1880, 207, 245], [1900, 209, 247],
  [1920, 212, 250], [1940, 214, 253], [1960, 216, 255], [1980, 218, 258], [2000, 220, 260],
  [2020, 223, 263], [2040, 225, 266], [2060, 227, 268], [2080, 229, 271], [2100, 231, 273],
  [2120, 234, 276], [2140, 236, 279], [2160, 238, 281], [2180, 240, 284], [2200, 242, 286],
  [2220, 245, 289], [2240, 247, 292], [2260, 249, 294], [2280, 251, 297], [2300, 253, 299],
  [2320, 256, 302], [2340, 258, 305], [2360, 260, 307], [2380, 262, 310], [2400, 264, 312],
  [2420, 267, 315], [2440, 269, 318], [2460, 271, 320], [2480, 273, 323], [2500, 275, 325],
  [2520, 278, 328], [2540, 280, 331], [2560, 282, 333], [2580, 284, 336], [2600, 286, 338],
  [2620, 289, 341], [2640, 291, 344], [2660, 293, 346], [2680, 295, 349], [2700, 297, 351],
  [2720, 300, 354], [2740, 302, 357], [2760, 304, 359], [2780, 306, 362], [2800, 308, 364],
  [2820, 311, 367], [2840, 313, 370], [2860, 315, 372], [2880, 317, 375], [2900, 319, 377],
  [2920, 322, 380], [2940, 324, 383], [2960, 326, 385], [2980, 328, 388], [3000, 330, 390],
  [3020, 333, 393], [3040, 335, 396], [3060, 337, 398], [3080, 339, 401], [3100, 341, 403],
  [3120, 344, 406], [3140, 346, 409], [3160, 348, 411], [3180, 350, 414], [3200, 352, 416],
  [3220, 355, 419], [3240, 357, 422], [3260, 359, 424], [3280, 361, 427], [3300, 363, 429],
  [3320, 366, 432], [3340, 368, 435], [3360, 370, 437], [3380, 372, 440], [3400, 374, 442],
  [3420, 377, 445], [3440, 379, 448], [3460, 381, 450], [3480, 383, 453], [3500, 385, 455],
  [3520, 388, 458], [3540, 390, 461], [3560, 392, 463], [3580, 394, 466], [3600, 396, 468],
  [3620, 399, 471], [3640, 401, 474], [3660, 403, 476], [3680, 405, 479], [3700, 407, 481],
  [3720, 410, 484], [3740, 412, 487], [3760, 414, 489], [3780, 416, 492], [3800, 418, 494],
  [3820, 421, 497], [3840, 423, 500], [3860, 425, 502], [3880, 427, 505], [3900, 429, 507],
  [3920, 432, 510], [3940, 434, 513], [3960, 436, 515], [3980, 438, 518], [4000, 440, 520],
  [4020, 443, 523], [4040, 445, 526], [4060, 447, 528], [4080, 449, 531], [4100, 451, 533],
  [4120, 454, 536], [4140, 456, 539], [4160, 458, 541], [4180, 460, 544], [4200, 462, 546],
  [4220, 465, 549], [4240, 467, 552], [4260, 469, 554], [4280, 471, 557], [4300, 473, 559],
  [4320, 476, 562], [4340, 478, 565], [4360, 480, 567], [4380, 482, 570], [4400, 484, 572],
  [4420, 487, 575], [4440, 489, 578], [4460, 491, 580], [4480, 493, 583], [4500, 495, 585],
  [4520, 498, 588], [4540, 500, 591], [4560, 502, 593], [4580, 504, 596], [4600, 506, 598],
  [4620, 509, 601], [4640, 511, 604], [4660, 513, 606], [4680, 515, 609], [4700, 517, 611],
  [4720, 520, 614], [4740, 522, 617], [4760, 524, 619], [4780, 526, 622], [4800, 528, 624],
  [4820, 531, 627], [4840, 533, 630], [4860, 535, 632], [4880, 537, 635], [4900, 539, 637],
  [4920, 542, 640], [4940, 544, 643], [4960, 546, 645], [4980, 548, 648], [5000, 550, 650],
  // Above RM5,000: RM100 increments, employer rate drops to 12%
  [5100, 561, 612], [5200, 572, 624], [5300, 583, 636], [5400, 594, 648], [5500, 605, 660],
  [5600, 616, 672], [5700, 627, 684], [5800, 638, 696], [5900, 649, 708], [6000, 660, 720],
  [6100, 671, 732], [6200, 682, 744], [6300, 693, 756], [6400, 704, 768], [6500, 715, 780],
  [6600, 726, 792], [6700, 737, 804], [6800, 748, 816], [6900, 759, 828], [7000, 770, 840],
  [7100, 781, 852], [7200, 792, 864], [7300, 803, 876], [7400, 814, 888], [7500, 825, 900],
  [7600, 836, 912], [7700, 847, 924], [7800, 858, 936], [7900, 869, 948], [8000, 880, 960],
  [8100, 891, 972], [8200, 902, 984], [8300, 913, 996], [8400, 924, 1008], [8500, 935, 1020],
  [8600, 946, 1032], [8700, 957, 1044], [8800, 968, 1056], [8900, 979, 1068], [9000, 990, 1080],
  [9100, 1001, 1092], [9200, 1012, 1104], [9300, 1023, 1116], [9400, 1034, 1128], [9500, 1045, 1140],
  [9600, 1056, 1152], [9700, 1067, 1164], [9800, 1078, 1176], [9900, 1089, 1188], [10000, 1100, 1200],
  [10100, 1111, 1212], [10200, 1122, 1224], [10300, 1133, 1236], [10400, 1144, 1248], [10500, 1155, 1260],
  [10600, 1166, 1272], [10700, 1177, 1284], [10800, 1188, 1296], [10900, 1199, 1308], [11000, 1210, 1320],
  [11100, 1221, 1332], [11200, 1232, 1344], [11300, 1243, 1356], [11400, 1254, 1368], [11500, 1265, 1380],
  [11600, 1276, 1392], [11700, 1287, 1404], [11800, 1298, 1416], [11900, 1309, 1428], [12000, 1320, 1440],
  [12100, 1331, 1452], [12200, 1342, 1464], [12300, 1353, 1476], [12400, 1364, 1488], [12500, 1375, 1500],
  [12600, 1386, 1512], [12700, 1397, 1524], [12800, 1408, 1536], [12900, 1419, 1548], [13000, 1430, 1560],
  [13100, 1441, 1572], [13200, 1452, 1584], [13300, 1463, 1596], [13400, 1474, 1608], [13500, 1485, 1620],
  [13600, 1496, 1632], [13700, 1507, 1644], [13800, 1518, 1656], [13900, 1529, 1668], [14000, 1540, 1680],
  [14100, 1551, 1692], [14200, 1562, 1704], [14300, 1573, 1716], [14400, 1584, 1728], [14500, 1595, 1740],
  [14600, 1606, 1752], [14700, 1617, 1764], [14800, 1628, 1776], [14900, 1639, 1788], [15000, 1650, 1800],
  [15100, 1661, 1812], [15200, 1672, 1824], [15300, 1683, 1836], [15400, 1694, 1848], [15500, 1705, 1860],
  [15600, 1716, 1872], [15700, 1727, 1884], [15800, 1738, 1896], [15900, 1749, 1908], [16000, 1760, 1920],
  [16100, 1771, 1932], [16200, 1782, 1944], [16300, 1793, 1956], [16400, 1804, 1968], [16500, 1815, 1980],
  [16600, 1826, 1992], [16700, 1837, 2004], [16800, 1848, 2016], [16900, 1859, 2028], [17000, 1870, 2040],
  [17100, 1881, 2052], [17200, 1892, 2064], [17300, 1903, 2076], [17400, 1914, 2088], [17500, 1925, 2100],
  [17600, 1936, 2112], [17700, 1947, 2124], [17800, 1958, 2136], [17900, 1969, 2148], [18000, 1980, 2160],
  [18100, 1991, 2172], [18200, 2002, 2184], [18300, 2013, 2196], [18400, 2024, 2208], [18500, 2035, 2220],
  [18600, 2046, 2232], [18700, 2057, 2244], [18800, 2068, 2256], [18900, 2079, 2268], [19000, 2090, 2280],
  [19100, 2101, 2292], [19200, 2112, 2304], [19300, 2123, 2316], [19400, 2134, 2328], [19500, 2145, 2340],
  [19600, 2156, 2352], [19700, 2167, 2364], [19800, 2178, 2376], [19900, 2189, 2388], [20000, 2200, 2400],
  // For wages above RM20,000: 11% employee, 12% employer (round up to next ringgit)
];

// SOCSO Contribution Table (2024 rates)
// Format: [maxWage, employeeContrib, employerContrib]
const SOCSO_TABLE = [
  [30, 0.10, 0.40],
  [50, 0.20, 0.70],
  [70, 0.30, 1.00],
  [100, 0.40, 1.30],
  [140, 0.60, 1.90],
  [200, 0.85, 2.65],
  [300, 1.25, 3.85],
  [400, 1.75, 5.35],
  [500, 2.25, 6.85],
  [600, 2.75, 8.35],
  [700, 3.25, 9.85],
  [800, 3.75, 11.35],
  [900, 4.25, 12.85],
  [1000, 4.75, 14.35],
  [1100, 5.25, 15.85],
  [1200, 5.75, 17.35],
  [1300, 6.25, 18.85],
  [1400, 6.75, 20.35],
  [1500, 7.25, 21.85],
  [1600, 7.75, 23.35],
  [1700, 8.25, 24.85],
  [1800, 8.75, 26.35],
  [1900, 9.25, 27.85],
  [2000, 9.75, 29.35],
  [2100, 10.25, 30.85],
  [2200, 10.75, 32.35],
  [2300, 11.25, 33.85],
  [2400, 11.75, 35.35],
  [2500, 12.25, 36.85],
  [2600, 12.75, 38.35],
  [2700, 13.25, 39.85],
  [2800, 13.75, 41.35],
  [2900, 14.25, 42.85],
  [3000, 14.75, 44.35],
  [3100, 15.25, 45.85],
  [3200, 15.75, 47.35],
  [3300, 16.25, 48.85],
  [3400, 16.75, 50.35],
  [3500, 17.25, 51.85],
  [3600, 17.75, 53.35],
  [3700, 18.25, 54.85],
  [3800, 18.75, 56.35],
  [3900, 19.25, 57.85],
  [4000, 19.75, 59.35],
  [4100, 20.25, 60.85],
  [4200, 20.75, 62.35],
  [4300, 21.25, 63.85],
  [4400, 21.75, 65.35],
  [4500, 22.25, 66.85],
  [4600, 22.75, 68.35],
  [4700, 23.25, 69.85],
  [4800, 23.75, 71.35],
  [4900, 24.25, 72.85],
  [5000, 24.75, 74.35],
  // For wages above 5000, max contribution applies
  [Infinity, 24.75, 74.35]
];

// EIS Contribution Table (2024 rates)
// Format: [maxWage, employeeContrib, employerContrib]
const EIS_TABLE = [
  [30, 0.05, 0.05],
  [50, 0.10, 0.10],
  [70, 0.15, 0.15],
  [100, 0.20, 0.20],
  [140, 0.25, 0.25],
  [200, 0.35, 0.35],
  [300, 0.50, 0.50],
  [400, 0.70, 0.70],
  [500, 0.90, 0.90],
  [600, 1.10, 1.10],
  [700, 1.30, 1.30],
  [800, 1.50, 1.50],
  [900, 1.70, 1.70],
  [1000, 1.90, 1.90],
  [1100, 2.10, 2.10],
  [1200, 2.30, 2.30],
  [1300, 2.50, 2.50],
  [1400, 2.70, 2.70],
  [1500, 2.90, 2.90],
  [1600, 3.10, 3.10],
  [1700, 3.30, 3.30],
  [1800, 3.50, 3.50],
  [1900, 3.70, 3.70],
  [2000, 3.90, 3.90],
  [2100, 4.10, 4.10],
  [2200, 4.30, 4.30],
  [2300, 4.50, 4.50],
  [2400, 4.70, 4.70],
  [2500, 4.90, 4.90],
  [2600, 5.10, 5.10],
  [2700, 5.30, 5.30],
  [2800, 5.50, 5.50],
  [2900, 5.70, 5.70],
  [3000, 5.90, 5.90],
  [3100, 6.10, 6.10],
  [3200, 6.30, 6.30],
  [3300, 6.50, 6.50],
  [3400, 6.70, 6.70],
  [3500, 6.90, 6.90],
  [3600, 7.10, 7.10],
  [3700, 7.30, 7.30],
  [3800, 7.50, 7.50],
  [3900, 7.70, 7.70],
  [4000, 7.90, 7.90],
  // For wages above 4000, max contribution applies
  [Infinity, 7.90, 7.90]
];

/**
 * Calculate EPF contributions using KWSP Third Schedule
 *
 * @param {number} wage - Wage for EPF calculation
 * @returns {object} { employee, employer }
 */
function calculateEPF(wage) {
  const w = wage || 0;
  if (w <= 0) return { employee: 0, employer: 0 };

  // Use table for wages up to RM 20,000
  for (const [maxWage, ee, er] of EPF_TABLE) {
    if (w <= maxWage) {
      return { employee: ee, employer: er };
    }
  }

  // For wages above RM 20,000, use percentage: 11% employee, 12% employer
  // Total contribution including cents shall be rounded to the next ringgit
  const employee = Math.ceil(w * 0.11);
  const employer = Math.ceil(w * 0.12);
  return { employee, employer };
}

/**
 * Calculate SOCSO contributions using contribution table
 *
 * @param {number} wage - Wage for SOCSO calculation
 * @returns {object} { employee, employer }
 */
function calculateSOCSO(wage) {
  const w = wage || 0;
  if (w <= 0) return { employee: 0, employer: 0 };

  for (const [maxWage, ee, er] of SOCSO_TABLE) {
    if (w <= maxWage) {
      return { employee: ee, employer: er };
    }
  }

  return { employee: 24.75, employer: 74.35 };
}

/**
 * Calculate EIS contributions using contribution table
 *
 * @param {number} wage - Wage for EIS calculation
 * @returns {object} { employee, employer }
 */
function calculateEIS(wage) {
  const w = wage || 0;
  if (w <= 0) return { employee: 0, employer: 0 };

  for (const [maxWage, ee, er] of EIS_TABLE) {
    if (w <= maxWage) {
      return { employee: ee, employer: er };
    }
  }

  return { employee: 7.90, employer: 7.90 };
}

/**
 * Calculate all statutory deductions
 *
 * @param {number} statutoryBase - Base wage for statutory calculation
 * @returns {object} All statutory calculations
 */
function calculateAllStatutory(statutoryBase) {
  const epf = calculateEPF(statutoryBase);
  const socso = calculateSOCSO(statutoryBase);
  const eis = calculateEIS(statutoryBase);

  return {
    epf_employee: epf.employee,
    epf_employer: epf.employer,
    socso_employee: socso.employee,
    socso_employer: socso.employer,
    eis_employee: eis.employee,
    eis_employer: eis.employer,
    total_employee: epf.employee + socso.employee + eis.employee,
    total_employer: epf.employer + socso.employer + eis.employer
  };
}

module.exports = {
  calculateEPF,
  calculateSOCSO,
  calculateEIS,
  calculateAllStatutory,
  EPF_TABLE,
  SOCSO_TABLE,
  EIS_TABLE
};
